{"version":3,"file":"react-global-states.umd.min.js","sources":["../node_modules/@babel/runtime/helpers/extends.js","../src/index.ts"],"sourcesContent":["function _extends() {\n  module.exports = _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nmodule.exports = _extends;","import { useState, useEffect } from 'react';\n\ninterface StoreMethods<Store> {\n\tuseGlobalStates(propsToConnectTo: (keyof Store)[]): Partial<Store>;\n\tgetStates(): Store;\n\tupdateStates(partial: Store): void;\n\tcreateSubPropUpdater<Prop extends keyof Store>(\n\t\tpropName: Prop\n\t): (partial: Partial<Store[Prop]>) => void;\n}\n\nexport const createStore = function createStore<YourStoreInterface>(\n\tinitStore: YourStoreInterface\n): StoreMethods<YourStoreInterface> {\n\ttype Store = YourStoreInterface;\n\ttype StoreKey = keyof Store;\n\ttype Handler = (store: Store) => void;\n\n\t// \"The\" global store\n\tlet store = initStore;\n\n\t// internal publisher-subscriber system to\n\t// notify containers of store changes.\n\tconst pubsub = {\n\t\thandlers: [] as Handler[],\n\t\tsubscribe(handler: Handler): void {\n\t\t\t// console.log('subscribed');\n\t\t\tif (!this.handlers.includes(handler)) {\n\t\t\t\tthis.handlers.push(handler);\n\t\t\t}\n\t\t},\n\t\tunsubscribe(handler: Handler): void {\n\t\t\t// console.log('unsubscribed');\n\t\t\tconst index = this.handlers.indexOf(handler);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.handlers.splice(index, 1);\n\t\t\t}\n\t\t},\n\t\tnotify(newStore: Store): void {\n\t\t\tthis.handlers.forEach((handler: Handler) => handler(newStore));\n\t\t},\n\t};\n\n\tconst getStates = (): YourStoreInterface => ({ ...store });\n\n\t// global state merger. unlike redux, I am not enforcing reducer layer\n\tconst updateStates = (partial: Store): void => {\n\t\tconst newStore = {\n\t\t\t...store,\n\t\t\t...partial,\n\t\t};\n\t\tstore = newStore;\n\t\tpubsub.notify(newStore);\n\t};\n\n\t// curry function to partially update a sub property of global store.\n\t// e.g const updateCartState = createSubPropUpdater('cart');\n\t// updateCartState({ items: [], quantity: 0 });\n\t// this is equivalent to\n\t// updateStates({ cart: { ...store.cart, items: [], quantity: 0 } })\n\tconst createSubPropUpdater = <Prop extends StoreKey>(propName: Prop) => (\n\t\tpartial: Partial<Store[Prop]>\n\t): void => {\n\t\tconst newStore = {\n\t\t\t...store,\n\t\t\t[propName]: {\n\t\t\t\t...(store[propName] || {}),\n\t\t\t\t...partial,\n\t\t\t},\n\t\t};\n\t\tstore = newStore;\n\t\tpubsub.notify(newStore);\n\t};\n\n\t// utility\n\tconst plainObjectPrototype = Object.getPrototypeOf({});\n\tconst twoLevelIsEqual = (\n\t\toldState: Store,\n\t\tnewState: Store,\n\t\tlevel = 1\n\t): boolean => {\n\t\tif (\n\t\t\toldState === null ||\n\t\t\tnewState === null ||\n\t\t\toldState === undefined ||\n\t\t\tnewState === undefined\n\t\t) {\n\t\t\treturn oldState === newState;\n\t\t}\n\n\t\tconst oldStatePrototype = Object.getPrototypeOf(oldState);\n\t\tif (\n\t\t\tlevel <= 2 &&\n\t\t\t(oldStatePrototype === plainObjectPrototype || Array.isArray(oldState)) &&\n\t\t\toldStatePrototype === Object.getPrototypeOf(newState)\n\t\t) {\n\t\t\t// check if all props of oldState is in newState\n\t\t\tlet isEqual = Object.entries(oldState).every(([key, val]) =>\n\t\t\t\ttwoLevelIsEqual(val, newState[key], level + 1)\n\t\t\t);\n\t\t\t// check if all props of newState is in oldState\n\t\t\tisEqual =\n\t\t\t\tisEqual &&\n\t\t\t\tObject.entries(newState).every(([key, val]) =>\n\t\t\t\t\ttwoLevelIsEqual(oldState[key], val, level + 1)\n\t\t\t\t);\n\t\t\t// if so, they are equal (upto two levels).\n\t\t\treturn isEqual;\n\t\t}\n\t\tif (oldState instanceof Date && newState instanceof Date) {\n\t\t\treturn oldState.getTime() === newState.getTime();\n\t\t}\n\t\treturn oldState === newState;\n\t};\n\n\tconst useGlobalStates = (\n\t\tpropsToConnectTo: StoreKey[]\n\t): Partial<YourStoreInterface> => {\n\t\tconst [state, setState] = useState(\n\t\t\tpropsToConnectTo.reduce((acc, propName) => {\n\t\t\t\tif (propName in store) {\n\t\t\t\t\tacc[propName] = store[propName];\n\t\t\t\t}\n\t\t\t\treturn acc;\n\t\t\t}, {} as Store)\n\t\t);\n\n\t\tconst propNameHash = propsToConnectTo\n\t\t\t.slice()\n\t\t\t.sort()\n\t\t\t.join('|');\n\t\tuseEffect(() => {\n\t\t\tconst newStateHandler = (newStore: Store): void => {\n\t\t\t\tconst newState = propsToConnectTo.reduce((acc, propName) => {\n\t\t\t\t\tif (propName in newStore) {\n\t\t\t\t\t\tacc[propName] = newStore[propName];\n\t\t\t\t\t}\n\t\t\t\t\treturn acc;\n\t\t\t\t}, {} as Store);\n\t\t\t\t// console.log('current state', state);\n\t\t\t\t// console.log('new state', newState);\n\t\t\t\t// console.log('twoLevelIsEqual', twoLevelIsEqual(state, newState));\n\t\t\t\tif (!twoLevelIsEqual(state, newState)) {\n\t\t\t\t\tsetState(newState);\n\t\t\t\t}\n\t\t\t};\n\t\t\tpubsub.subscribe(newStateHandler);\n\t\t\t// on component unmount, unsubscribe to prevent mem leak\n\t\t\treturn (): void => pubsub.unsubscribe(newStateHandler);\n\t\t\t// eslint-disable-next-line react-hooks/exhaustive-deps\n\t\t}, [state, propNameHash]);\n\n\t\treturn state;\n\t};\n\n\treturn {\n\t\tuseGlobalStates,\n\t\tgetStates,\n\t\tupdateStates,\n\t\tcreateSubPropUpdater,\n\t};\n};\n\nconst defaultStore = createStore({});\n\nexport const {\n\tuseGlobalStates,\n\tgetStates,\n\tupdateStates,\n\tcreateSubPropUpdater,\n} = defaultStore;\n\n// -------------- app code testing ------------------\n/*\ninterface MyStoreType {\n\tgreeting: string;\n\tcart: {\n\t\ttotalQty: number;\n\t\titems: {\n\t\t\tqty: number;\n\t\t\tsku: string;\n\t\t}[];\n\t};\n\ttest: {\n\t\ttest2: string;\n\t};\n}\nconst myStore = createStore<MyStoreType>({\n\tgreeting: 'hi',\n\tcart: { totalQty: 0, items: [] },\n\ttest: { test2: 'hi' },\n});\nconst updateCart = myStore.createSubPropUpdater('cart');\nupdateCart({ greeting: 'hi' }); // error\nupdateCart({ cart: {} }); // error\nupdateCart({ test: {} }); // error\nupdateCart({ test2: 'h1' }); // error\nupdateCart({ totalQty: 0, items: [] }); // no error\n*/\n"],"names":["_extends","module","Object","assign","target","i","arguments","length","source","key","prototype","hasOwnProperty","call","apply","this","createStore","initStore","store","pubsub","handlers","subscribe","handler","includes","push","unsubscribe","index","indexOf","splice","notify","newStore","forEach","plainObjectPrototype","getPrototypeOf","twoLevelIsEqual","oldState","newState","level","undefined","oldStatePrototype","Array","isArray","isEqual","entries","every","val","Date","getTime","useGlobalStates","propsToConnectTo","useState","reduce","acc","propName","state","setState","propNameHash","slice","sort","join","useEffect","newStateHandler","getStates","updateStates","partial","createSubPropUpdater","defaultStore"],"mappings":"sUAAA,SAASA,IAeP,OAdAC,UAAiBD,EAAWE,OAAOC,QAAU,SAAUC,GACrD,IAAK,IAAIC,EAAI,EAAGA,EAAIC,UAAUC,OAAQF,IAAK,CACzC,IAAIG,EAASF,UAAUD,GAEvB,IAAK,IAAII,KAAOD,EACVN,OAAOQ,UAAUC,eAAeC,KAAKJ,EAAQC,KAC/CL,EAAOK,GAAOD,EAAOC,IAK3B,OAAOL,GAGFJ,EAASa,MAAMC,KAAMR,WAG9BL,UAAiBD,KCPJe,EAAc,SAC1BC,OAOIC,EAAQD,EAINE,EAAS,CACdC,SAAU,GACVC,mBAAUC,GAEJP,KAAKK,SAASG,SAASD,SACtBF,SAASI,KAAKF,IAGrBG,qBAAYH,OAELI,EAAQX,KAAKK,SAASO,QAAQL,GAChCI,GAAS,QACPN,SAASQ,OAAOF,EAAO,IAG9BG,gBAAOC,QACDV,SAASW,SAAQ,SAACT,UAAqBA,EAAQQ,QAoChDE,EAAuB7B,OAAO8B,eAAe,IAC7CC,EAAkB,SACvBC,EACAC,EACAC,eAAAA,IAAAA,EAAQ,GAGM,OAAbF,GACa,OAAbC,QACaE,IAAbH,QACaG,IAAbF,SAEOD,IAAaC,MAGfG,EAAoBpC,OAAO8B,eAAeE,MAE/CE,GAAS,IACRE,IAAsBP,GAAwBQ,MAAMC,QAAQN,KAC7DI,IAAsBpC,OAAO8B,eAAeG,GAC3C,KAEGM,EAAUvC,OAAOwC,QAAQR,GAAUS,OAAM,gBAAElC,OAAKmC,cACnDX,EAAgBW,EAAKT,EAAS1B,GAAM2B,EAAQ,aAG7CK,EACCA,GACAvC,OAAOwC,QAAQP,GAAUQ,OAAM,gBAAElC,OAAKmC,cACrCX,EAAgBC,EAASzB,GAAMmC,EAAKR,EAAQ,aAK3CF,aAAoBW,MAAQV,aAAoBU,KAC5CX,EAASY,YAAcX,EAASW,UAEjCZ,IAAaC,SA2Cd,CACNY,gBAzCuB,SACvBC,SAE0BC,WACzBD,EAAiBE,QAAO,SAACC,EAAKC,UACzBA,KAAYnC,IACfkC,EAAIC,GAAYnC,EAAMmC,IAEhBD,IACL,KANGE,OAAOC,OASRC,EAAeP,EACnBQ,QACAC,OACAC,KAAK,YACPC,aAAU,eACHC,EAAkB,SAAC/B,OAClBM,EAAWa,EAAiBE,QAAO,SAACC,EAAKC,UAC1CA,KAAYvB,IACfsB,EAAIC,GAAYvB,EAASuB,IAEnBD,IACL,IAIElB,EAAgBoB,EAAOlB,IAC3BmB,EAASnB,WAGXjB,EAAOE,UAAUwC,GAEV,kBAAY1C,EAAOM,YAAYoC,MAEpC,CAACP,EAAOE,IAEJF,GAKPQ,UAlHiB,uBAAgC5C,IAmHjD6C,aAhHoB,SAACC,OACflC,OACFZ,KACA8C,GAEJ9C,EAAQY,EACRX,EAAOU,OAAOC,IA2GdmC,qBAnG4B,SAAwBZ,UAAmB,SACvEW,SAEMlC,OACFZ,UACFmC,QACInC,EAAMmC,IAAa,MACpBW,OAGL9C,EAAQY,EACRX,EAAOU,OAAOC,OA4FVoC,EAAelD,EAAY,IAGhCgC,EAIGkB,EAJHlB,gBACAc,EAGGI,EAHHJ,UACAC,EAEGG,EAFHH,aACAE,EACGC,EADHD"}